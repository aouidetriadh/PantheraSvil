package it.thera.thip.base.commessa.web;import java.io.*;import java.sql.SQLException;import java.util.*;import javax.servlet.*;import com.thera.thermfw.ad.*;import com.thera.thermfw.base.*;import com.thera.thermfw.gui.cnr.*;import com.thera.thermfw.persist.*;import com.thera.thermfw.web.*;import com.thera.thermfw.web.servlet.*;import it.thera.thip.base.commessa.*;import it.thera.thip.base.documentoDgt.web.*;import it.thera.thip.produzione.commessa.ConsuntivoCommessa;import it.thera.thip.produzione.commessa.VariaBudgetCommessa;/** * CommessaActionAdapter * <br></br><b>Copyright (C) : Thera s.p.a.</b> * @author xxx *//* * Revisions: * Number  Date          Owner      Description * 04459   12/10/2005    LP         Rilascio nuova gestione commesse * 04475   18/11/2005    IT         Modificata estensione per gestire bottone DocDgt Collegati * 04361   21/09/2005    SAYADI     add riapertura action * 07430   09/07/2007    LP         Corretto gestione eccezioni * 13297   29/10/2010    FM         Piano fatturazione con WF * 15938   21/03/2012    FM         Apertura automatica ordine cliente * 33950   25/08/2021    RA			Aggiunto azione consuntivo commessa * 34795   16/02/2021	 RA			Aggiunto azione variazione budget commessa * 35382   07/03/2022    RA			Integrazione budget dentro commenssa * 35837   04/04/2022    RA			Aggiunto azione  SCOSTAMENTO_BUDGET * 36460   13/09/2022    RA			Aggiunto azione  EVOLUZIONE_BUDGET e EVOLUZIONE_CONSUNTIVI *///public class CommessaActionAdapter extends FormActionAdapter {public class CommessaActionAdapter extends DocDgtClgFormActionAdapter {  public static final String RISORSA = "it.thera.thip.base.commessa.resources.Commessa";  public static final String CHECK_BEFORE_SAVE = "CHECK_BEFORE_SAVE";  public static final String CHECK_BEFORE_SPOSTA = "CHECK_BEFORE_SPOSTA";  public static final String ACTION__SPOSTA = "SPOSTA";  public static final String ACTION__RIAPERTURA = "RIAPERTURA"; //Fix 04361  public static final String NUOVO_ORDINE = "NUOVO_ORDINE"; //Fix 15938  public static final String WF_CHANGE_STATUS = "WF_CHANGE_STATUS";  //35382 inizio  public static final String NUOVO_BUDGET ="NUOVO_BUDGET";    public static final String LISTA_BUDGET ="LISTA_BUDGET";  public static final String EVOLUZIONE_BUDGET ="EVOLUZIONE_BUDGET";//36460  public static final String SCOSTAMENTO_BUDGET ="SCOSTAMENTO_BUDGET";  //35837  public static final String NUOVA_VARIAZIONE ="NUOVA_VARIAZIONE";  public static final String ULTIMA_VARIAZIONE ="ULTIMA_VARIAZIONE";  public static final String LISTA_VARIAZIONI ="LISTA_VARIAZIONI";    public static final String NUOVO_CONSUNTIVO ="NUOVO_CONSUNTIVO";  public static final String ULTIMO_CONSUNTIVO ="ULTIMO_CONSUNTIVO";  public static final String LISTA_CONSUNTIVI ="LISTA_CONSUNTIVI";  public static final String EVOLUZIONE_CONSUNTIVI ="EVOLUZIONE_CONSUNTIVI";//36460  //35382 fine  /**   * otherActions   * @param cadc ClassADCollection   * @param se ServletEnvironment   * @throws ServletException   * @throws IOException   */  protected void otherActions(ClassADCollection cadc, ServletEnvironment se) throws ServletException, IOException {    super.otherActions(cadc, se); //Mod.4475    String action = BaseServlet.getStringParameter(se.getRequest(), FormActionAdapter.ACTION).toUpperCase();    if(action.equals(CHECK_BEFORE_SAVE))      save(cadc, se);    else if(action.equals(ACTION__SPOSTA) || action.equals(CHECK_BEFORE_SPOSTA))      se.sendRequest(getServletContext(), getSpostaURL(se), true);    else if(action.equals(ACTION__RIAPERTURA)) //Fix 04361      se.sendRequest(getServletContext(), getRiaperturaURL(se), true); //Fix 04361    else if(action.equals(NUOVO_ORDINE)) //Fix 15938      saveECreaOrdine(cadc, se);      //super.otherActions(cadc, se);    //35382 inizio    else if(action.equals(NUOVO_BUDGET))    	apriNuovaBudget(se);     else if(action.equals(LISTA_BUDGET))    	apriListaBudget(se);    //36460 inizio    else if(action.equals(EVOLUZIONE_BUDGET))    	apriEvoluzioneBudget(se);    //36460 fine    //35837 inizio    else if(action.equals(SCOSTAMENTO_BUDGET))    	apriScostamentoBudget(se);    //35837 fine    else if(action.equals(NUOVA_VARIAZIONE))    	apriNuovaVariazione(se);        else if(action.equals(ULTIMA_VARIAZIONE))    	apriUltimaVariazione(se);    else if(action.equals(LISTA_VARIAZIONI))    	apriListaVariazioni(se);    else if(action.equals(NUOVO_CONSUNTIVO))    	apriNuovoConsuntivo(se);    else if(action.equals(ULTIMO_CONSUNTIVO))    	apriUltimoConsuntivo(se);    else if(action.equals(LISTA_CONSUNTIVI))    	apriListaConsuntivi(se);        //36460 inizio    else if(action.equals(EVOLUZIONE_CONSUNTIVI))    	apriEvoluzioneConsuntivo(se);     //36460 fine    //35382 fine  }  /**   * getSpostaUrl   * @param se ServletEnvironment   * @return String   */  public String getSpostaURL(ServletEnvironment se) {    return se.getServletPath() + "it.thera.thip.base.commessa.web.SpostaCommessaAppartenenza";  }  //Begin Fix 04361  /**   * getRiaperturaURL   * @param se ServletEnvironment   * @return String   */  public String getRiaperturaURL(ServletEnvironment se) {    return se.getServletPath() + "it.thera.thip.base.commessa.web.RiaperturaCommessa";  }  /**   * modifyMenuBar   * @param menuBar WebMenuBar   */  public void modifyMenuBar(WebMenuBar menuBar) {    WebMenu objectMenu = (WebMenu)menuBar.getMenu("ObjectMenu");    Commessa commessa = (Commessa)menuBar.getOwnerForm().getBODataCollector().getBo();    if(isRiaperturaDenied(commessa)) {      objectMenu.addMenu(getRiaperturaMenuItem());    }    if(isCopiaConSottoCommessa(menuBar.getOwnerForm().getMode(), commessa)) {      ArrayList nameSequence = new ArrayList();      nameSequence.add("SaveAndNew");      objectMenu.removeMenu(nameSequence);      nameSequence.clear();      nameSequence.add("SaveAndClose");      objectMenu.removeMenu(nameSequence);    }    //33950 inizio    if(commessa.getCommessaAppartenenza() == null) {    	//35382 inizio		WebMenuItem listaBudget = new WebMenuItem("ListaBudget", "action_submit", "new", "no",				"it.thera.thip.produzione.commessa.resources.BudgetCommessa", "ListaBudget", LISTA_BUDGET, "single",				false, null);		objectMenu.addMenu(listaBudget);		//36460 inizio		WebMenuItem evoluzioneBudget = new WebMenuItem("EvoluzioneBudget", "action_submit", "new", "no",				"it.thera.thip.produzione.commessa.resources.BudgetCommessa", "EvoluzioneBudget", EVOLUZIONE_BUDGET, "single",				false, null);		objectMenu.addMenu(evoluzioneBudget);		//36460 fine		//35837 inizio		WebMenuItem scostamentoBudget = new WebMenuItem("ScostamentoBudget", "action_submit", "new", "no",				"it.thera.thip.produzione.commessa.resources.BudgetCommessa", "ScostamentoBudget", SCOSTAMENTO_BUDGET,				"single", false, null);		objectMenu.addMenu(scostamentoBudget);		//35837 fine				if (!commessa.esisteVariazioneProvvisorio()) {			WebMenuItem nuovaVariazione = new WebMenuItem("NuovaVariazione", "action_submit", "new", "no",					"it.thera.thip.produzione.commessa.resources.BudgetCommessa", "NuovaVariazione", NUOVA_VARIAZIONE,					"single", false, null);			objectMenu.addMenu(nuovaVariazione);		}		if (commessa.esisteVariazioneProvvisorio()) {			WebMenuItem ultimaVariazione = new WebMenuItem("UltimaVariazione", "action_submit", "new", "no",					"it.thera.thip.produzione.commessa.resources.BudgetCommessa", "UltimaVariazione", ULTIMA_VARIAZIONE,					"single", false, null);			objectMenu.addMenu(ultimaVariazione);		}		WebMenuItem listaVariazioni = new WebMenuItem("ListaVariazioni", "action_submit", "new", "no",				"it.thera.thip.produzione.commessa.resources.BudgetCommessa", "ListaVariazioni", LISTA_VARIAZIONI,				"single", false, null);		objectMenu.addMenu(listaVariazioni);		WebMenuItem nuovoConsuntivo = new WebMenuItem("NuovoConsuntivo", "action_submit", "new", "no",				"it.thera.thip.produzione.commessa.resources.BudgetCommessa", "NuovoConsuntivo", NUOVO_CONSUNTIVO,				"single", false, null);		objectMenu.addMenu(nuovoConsuntivo);		if (commessa.esisteConsuntivoCommessa()) {			WebMenuItem ultimoConsuntivo = new WebMenuItem("UltimoConsuntivo", "action_submit", "new", "no",					"it.thera.thip.produzione.commessa.resources.BudgetCommessa", "UltimoConsuntivo", ULTIMO_CONSUNTIVO,					"single", false, null);			objectMenu.addMenu(ultimoConsuntivo);			WebMenuItem listaConsuntivi = new WebMenuItem("ListaConsuntivi", "action_submit", "new", "no",					"it.thera.thip.produzione.commessa.resources.BudgetCommessa", "ListaConsuntivi", LISTA_CONSUNTIVI,					"single", false, null);			objectMenu.addMenu(listaConsuntivi);			//36460 inzio			WebMenuItem evoluzioneConsuntivi = new WebMenuItem("EvoluzioneConsuntivi", "action_submit", "new", "no",					"it.thera.thip.produzione.commessa.resources.BudgetCommessa", "EvoluzioneConsuntivi",					EVOLUZIONE_CONSUNTIVI, "single", false, null);			objectMenu.addMenu(evoluzioneConsuntivi);			//36460 fine		}		// 35382 fine    }    //33950 fine  }  /**   * modifyToolBar   * @param toolBar WebToolBar   */  public void modifyToolBar(WebToolBar toolBar) {    super.modifyToolBar(toolBar);    Commessa commessa = (Commessa)toolBar.getOwnerForm().getBODataCollector().getBo();    if(isRiaperturaDenied(commessa)) {      toolBar.addButton("SaveAndNew", getRiaperturaButton());    }    if(isCopiaConSottoCommessa(toolBar.getOwnerForm().getMode(), commessa)) {      toolBar.removeButton("SaveAndNew");      toolBar.removeButton("SaveAndClose");    }    //33950 inizio    if(commessa.getCommessaAppartenenza() == null) {	    //35382 inizio	    toolBar.addButton("SaveScreenData", getBudgetButton(commessa));	    toolBar.addButton("AzioniBudget", getConsuntivoButton(commessa));	    //35382 fine    }    //33950 fine  }  /**   * isCopiaConSottoCommessa   * @param mode int   * @param commessa Commessa   * @return boolean   */  public boolean isCopiaConSottoCommessa(int mode, Commessa commessa) {    if(mode != OpenType.COPY)      return false;    try {      Commessa originale = (Commessa)Commessa.elementWithKey(commessa.getKey(), PersistentObject.NO_LOCK);      return!originale.getSottocommesse().isEmpty();    }    catch(Exception ex) {      ex.printStackTrace(Trace.excStream); //...FIX 7430    }    return false;  }  /**   * isRiaperturaDenied   * @param commessa Commessa   * @return boolean   */  public boolean isRiaperturaDenied(Commessa commessa) {    return(commessa.getIdCommessaAppartenenza() == null) && (commessa.getStatoAvanzamento() == Commessa.STATO_AVANZAM__CHIUSA_CONTABILAMENTO);  }  /**   * getRiaperturaButton   * @return WebToolBarButton   */  public WebToolBarButton getRiaperturaButton() {    return new WebToolBarButton("riapertura",      "action_submit",      "errorsFrame",      "no",      RISORSA,      "riapertura",      "it/thera/thip/base/commessa/images/riapertura.gif",      "RIAPERTURA",      "none",      false);  }  /**   * getRiaperturaMenuItem   * @return WebMenuItem   */  public WebMenuItem getRiaperturaMenuItem() {    return new WebMenuItem("riapertura",      "action_submit",      "errorsFrame",      "no",      RISORSA,      "riapertura",      "RIAPERTURA",      "none",      false,      null);  }  //End Fix 04361  //Mod.4475 - inizio  /**   * Costruisce il Filtro per l'apertura dei DocDgt Collegati   * @see it.thera.thip.base.documentoDgt.web.DocDgtClgFormActionAdapter#getFiltro(com.thera.thermfw.web.ServletEnvironment)   * @param se ServletEnvironment   * @return String   */  protected String getFiltro(ServletEnvironment se) {    String url = "IdCliente=&IdArticolo=&IdCommessa=";    String idCommessa = getStringParameter(se.getRequest(), "IdCommessa");    if(idCommessa != null && !idCommessa.equals(""))      url += idCommessa;    return url;  }  //Mod.4475 - fine  // FIX 13297 begin  protected void wfChangeStatus(ServletEnvironment se) throws ServletException, IOException  {    se.sendRequest(getServletContext(), se.getServletPath() + "it.thera.thip.base.commessa.web.CommessaWorkflowServlet", true);  } // FIX 13297 end  //Fix 15938 begin  protected void saveECreaOrdine(ClassADCollection cadc, ServletEnvironment se) throws ServletException, IOException  {    se.sendRequest(getServletContext(), se.getServletPath() + "it.thera.thip.base.commessa.web.CommessaSaveECreaOrdine", true);  } //Fix 15938 end  //35382 inizio    protected void apriNuovaBudget(ServletEnvironment se) throws ServletException, IOException {	  ClassADCollection cadc = getClassADCollection("Commessa");	  String key = getStringParameter(se.getRequest(), "thKey");	  String idAzienda = KeyHelper.getTokenObjectKey(key,1);	  String idCommessa = KeyHelper.getTokenObjectKey(key,2);	  String commessaKey = KeyHelper.buildObjectKey(new Object[] {idAzienda,idCommessa});	  String parameters = "?thAction=NEW&thClassName=BudgetCommessa&ObjectKey=" + commessaKey ;	  parameters += "&Opener=COMMESSA";	  String url = "/" +com.thera.thermfw.base.IniFile.getValue("Web", "WebApplicationPath") +			       "/" + com.thera.thermfw.base.IniFile.getValue("thermfw.ini","Web", "ServletPath") +			       "/" + cadc.getActionAdapterNameWeb() + parameters;	  se.getResponse().getOutputStream().print("<script>");	  se.getResponse().getOutputStream().print("window.location = '" + url + "'; ");	  se.getResponse().getOutputStream().print("</script>");  }    protected void apriNuovoConsuntivo(ServletEnvironment se) throws ServletException, IOException {	  ClassADCollection cadc = getClassADCollection("Commessa");	  String key = getStringParameter(se.getRequest(), "thKey");	  String idAzienda = KeyHelper.getTokenObjectKey(key,1);	  String idCommessa = KeyHelper.getTokenObjectKey(key,2);	  String commessaKey = KeyHelper.buildObjectKey(new Object[] {idAzienda,idCommessa});	  String parameters = "?thAction=NEW&thClassName=ConsuntivoCommessa&ObjectKey=" + commessaKey ;	  parameters += "&Opener=COMMESSA";	  String url = "/" +com.thera.thermfw.base.IniFile.getValue("Web", "WebApplicationPath") +			       "/" + com.thera.thermfw.base.IniFile.getValue("thermfw.ini","Web", "ServletPath") +			       "/" + cadc.getActionAdapterNameWeb() + parameters;	  se.getResponse().getOutputStream().print("<script>");	  se.getResponse().getOutputStream().print("window.location = '" + url + "'; ");	  se.getResponse().getOutputStream().print("</script>");  }  protected void apriNuovaVariazione(ServletEnvironment se) throws ServletException, IOException{	  ClassADCollection cadc = getClassADCollection("Commessa");	  String key = getStringParameter(se.getRequest(), "thKey");	  String idAzienda = KeyHelper.getTokenObjectKey(key,1);	  String idCommessa = KeyHelper.getTokenObjectKey(key,2);	  String commessaKey = KeyHelper.buildObjectKey(new Object[] {idAzienda,idCommessa});	  String parameters = "?thAction=NEW&thClassName=VariaBudgetCommessa&ObjectKey=" + commessaKey ;	  parameters += "&Opener=COMMESSA";	  String url = "/" +com.thera.thermfw.base.IniFile.getValue("Web", "WebApplicationPath") +			       "/" + com.thera.thermfw.base.IniFile.getValue("thermfw.ini","Web", "ServletPath") +			       "/" + cadc.getActionAdapterNameWeb() + parameters;	  se.getResponse().getOutputStream().print("<script>");	  se.getResponse().getOutputStream().print("window.location = '" + url + "'; ");	  se.getResponse().getOutputStream().print("</script>");  }    //35837 inizio  protected void apriScostamentoBudget(ServletEnvironment se) throws ServletException, IOException{	  ClassADCollection cadc = getClassADCollection("Commessa");	  String key = getStringParameter(se.getRequest(), "thKey");	  String idAzienda = KeyHelper.getTokenObjectKey(key,1);	  String idCommessa = KeyHelper.getTokenObjectKey(key,2);	  String commessaKey = KeyHelper.buildObjectKey(new Object[] {idAzienda,idCommessa});	  String parameters = "?thAction=NEW&thClassName=ScostamentoBudgetCommessa&ObjectKey=" + commessaKey ;	  parameters += "&Opener=COMMESSA";	  String url = "/" +com.thera.thermfw.base.IniFile.getValue("Web", "WebApplicationPath") +			       "/" + com.thera.thermfw.base.IniFile.getValue("thermfw.ini","Web", "ServletPath") +			       "/" + cadc.getActionAdapterNameWeb() + parameters;	  se.getResponse().getOutputStream().print("<script>");	  se.getResponse().getOutputStream().print("window.location = '" + url + "'; ");	  se.getResponse().getOutputStream().print("</script>");  }  //35837 fine  protected void apriUltimaVariazione(ServletEnvironment se) throws ServletException, IOException{	  VariaBudgetCommessa ultimoVariazione = null;	  ClassADCollection cadc = getClassADCollection("VariaBudgetCommessa");	  String key = getStringParameter(se.getRequest(), "thKey");	  String idAzienda = KeyHelper.getTokenObjectKey(key,1);	  String idCommessa = KeyHelper.getTokenObjectKey(key,2);	  String commessaKey = KeyHelper.buildObjectKey(new Object[] {idAzienda,idCommessa});	  try {		  Commessa commessa = Commessa.elementWithKey(commessaKey, PersistentObject.NO_LOCK);		  ultimoVariazione = commessa.getUltimoVariaBudgetCommessa();	  } 	  catch (SQLException e) {		  e.printStackTrace(Trace.excStream);	  }	  if(ultimoVariazione != null) {		  String parameters = "?thAction=UPDATE&thClassName=VariaBudgetCommessa&ObjectKey=" + ultimoVariazione.getKey() ;		  String url = "/" +com.thera.thermfw.base.IniFile.getValue("Web", "WebApplicationPath") +				       "/" + com.thera.thermfw.base.IniFile.getValue("thermfw.ini","Web", "ServletPath") +				       "/" + cadc.getActionAdapterNameWeb() + parameters;		  se.getResponse().getOutputStream().print("<script>");		  se.getResponse().getOutputStream().print("window.location = '" + url + "'; ");		  se.getResponse().getOutputStream().print("</script>");	  }  }    protected void apriUltimoConsuntivo(ServletEnvironment se) throws ServletException, IOException{	  ConsuntivoCommessa ultimoConsuntivo = null;	  ClassADCollection cadc = getClassADCollection("ConsuntivoCommessa");	  String key = getStringParameter(se.getRequest(), "thKey");	  String idAzienda = KeyHelper.getTokenObjectKey(key,1);	  String idCommessa = KeyHelper.getTokenObjectKey(key,2);	  String commessaKey = KeyHelper.buildObjectKey(new Object[] {idAzienda,idCommessa});	  try {		  Commessa commessa = Commessa.elementWithKey(commessaKey, PersistentObject.NO_LOCK);		  ultimoConsuntivo = commessa.getUltimoConsuntivoCommessa();	  } 	  catch (SQLException e) {		  e.printStackTrace(Trace.excStream);	  }	  if(ultimoConsuntivo != null) {		  String parameters = "?thAction=UPDATE&thClassName=ConsuntivoCommessa&ObjectKey=" + ultimoConsuntivo.getKey() ;		  String url = "/" +com.thera.thermfw.base.IniFile.getValue("Web", "WebApplicationPath") +				       "/" + com.thera.thermfw.base.IniFile.getValue("thermfw.ini","Web", "ServletPath") +				       "/" + cadc.getActionAdapterNameWeb() + parameters;		  se.getResponse().getOutputStream().print("<script>");		  se.getResponse().getOutputStream().print("window.location = '" + url + "'; ");		  se.getResponse().getOutputStream().print("</script>");	  }  }    protected void apriListaBudget(ServletEnvironment se) throws ServletException, IOException{	  String key = getStringParameter(se.getRequest(), "thKey");	  String idCommessa = KeyHelper.getTokenObjectKey(key,2);	  String parameters = "thGridType=list&ClassName=BudgetCommessa&thRestrictConditions=IdCommessa=" + idCommessa ;	  String url = "/" +com.thera.thermfw.base.IniFile.getValue("Web", "WebApplicationPath") +			       "/" + com.thera.thermfw.base.IniFile.getValue("thermfw.ini","Web", "ServletPath") +			       "/com.thera.thermfw.web.servlet.Execute?"  + parameters;	  se.getResponse().getOutputStream().print("<script>");	  se.getResponse().getOutputStream().print("window.location = '" + url + "'; ");	  se.getResponse().getOutputStream().print("</script>");  }    protected void apriListaConsuntivi(ServletEnvironment se) throws ServletException, IOException{	  String key = getStringParameter(se.getRequest(), "thKey");	  String idCommessa = KeyHelper.getTokenObjectKey(key,2);	  String parameters = "thGridType=list&ClassName=ConsuntivoCommessa&thRestrictConditions=IdCommessa=" + idCommessa ;	  String url = "/" +com.thera.thermfw.base.IniFile.getValue("Web", "WebApplicationPath") +			       "/" + com.thera.thermfw.base.IniFile.getValue("thermfw.ini","Web", "ServletPath") +			       "/com.thera.thermfw.web.servlet.Execute?"  + parameters;	  se.getResponse().getOutputStream().print("<script>");	  se.getResponse().getOutputStream().print("window.location = '" + url + "'; ");	  se.getResponse().getOutputStream().print("</script>");  }    protected void apriListaVariazioni(ServletEnvironment se) throws ServletException, IOException{	  String key = getStringParameter(se.getRequest(), "thKey");	  String idCommessa = KeyHelper.getTokenObjectKey(key,2);	  String parameters = "thGridType=list&ClassName=VariaBudgetCommessa&thRestrictConditions=IdCommessa=" + idCommessa ;	  String url = "/" +com.thera.thermfw.base.IniFile.getValue("Web", "WebApplicationPath") +			       "/" + com.thera.thermfw.base.IniFile.getValue("thermfw.ini","Web", "ServletPath") +			       "/com.thera.thermfw.web.servlet.Execute?"  + parameters;	  se.getResponse().getOutputStream().print("<script>");	  se.getResponse().getOutputStream().print("window.location = '" + url + "'; ");	  se.getResponse().getOutputStream().print("</script>");  }  	public WebToolBarPullDownButton getBudgetButton(Commessa commessa) {		WebToolBarPullDownButton budgetButton = new WebToolBarPullDownButton("AzioniBudget", "", "", "no",				"it.thera.thip.produzione.commessa.resources.BudgetCommessa", "AzioniBudget",				"it/thera/thip/produzione/commessa/images/CommessaBudget.gif", "", "single", false, false, null, null);		WebToolBarPullDownAction listaBudgetAction = new WebToolBarPullDownAction("ListaBudget", "action_submit", "new",				"no", "it.thera.thip.produzione.commessa.resources.BudgetCommessa", "ListaBudget", null, LISTA_BUDGET,				"single", false, false, null, null);		budgetButton.addAction(listaBudgetAction);				//36460 inizio		WebToolBarPullDownAction evoluzioneBudgetAction = new WebToolBarPullDownAction("EvoluzioneBudget", "action_submit",				"new", "no", "it.thera.thip.produzione.commessa.resources.BudgetCommessa", "EvoluzioneBudget", null,				EVOLUZIONE_BUDGET, "single", false, false, null, null);		budgetButton.addAction(evoluzioneBudgetAction);		//36460 fine				//35837 inizio		WebToolBarPullDownAction scostamentoBudgetAction = new WebToolBarPullDownAction("ScostamentoBudget",				"action_submit", "new", "no", "it.thera.thip.produzione.commessa.resources.BudgetCommessa",				"ScostamentoBudget", null, SCOSTAMENTO_BUDGET, "single", false, false, null, null);		budgetButton.addAction(scostamentoBudgetAction);		//35837 fine				if (!commessa.esisteVariazioneProvvisorio()) {			WebToolBarPullDownAction nuovaVariazioneAction = new WebToolBarPullDownAction("NuovaVariazione",					"action_submit", "new", "no", "it.thera.thip.produzione.commessa.resources.BudgetCommessa",					"NuovaVariazione", null, NUOVA_VARIAZIONE, "single", false, false, null, null);			budgetButton.addAction(nuovaVariazioneAction);		}				if (commessa.esisteVariazioneProvvisorio()) {			WebToolBarPullDownAction ultimaVariazioneAction = new WebToolBarPullDownAction("UltimaVariazione",					"action_submit", "new", "no", "it.thera.thip.produzione.commessa.resources.BudgetCommessa",					"UltimaVariazione", null, ULTIMA_VARIAZIONE, "single", false, false, null, null);			budgetButton.addAction(ultimaVariazioneAction);		}				WebToolBarPullDownAction listaVariazioniAction = new WebToolBarPullDownAction("ListaVariazioni",				"action_submit", "new", "no", "it.thera.thip.produzione.commessa.resources.BudgetCommessa",				"ListaVariazioni", null, LISTA_VARIAZIONI, "single", false, false, null, null);		budgetButton.addAction(listaVariazioniAction);				return budgetButton;	}	public WebToolBarPullDownButton getConsuntivoButton(Commessa commessa) {		WebToolBarPullDownButton consuntivoButton = new WebToolBarPullDownButton("AzioniConsuntivo", "", "", "no",				"it.thera.thip.produzione.commessa.resources.BudgetCommessa", "AzioniConsuntivo",				"it/thera/thip/produzione/commessa/images/CommessaConsuntivo.gif", "", "single", false, false, null,				null);		WebToolBarPullDownAction nuovoConsuntivoAction = new WebToolBarPullDownAction("NuovoConsuntivo",				"action_submit", "new", "no", "it.thera.thip.produzione.commessa.resources.BudgetCommessa",				"NuovoConsuntivo", null, NUOVO_CONSUNTIVO, "single", false, false, null, null);		consuntivoButton.addAction(nuovoConsuntivoAction);				if(commessa.esisteConsuntivoCommessa()) {			WebToolBarPullDownAction ultimoConsuntivoAction = new WebToolBarPullDownAction("UltimoConsuntivo",					"action_submit", "new", "no", "it.thera.thip.produzione.commessa.resources.BudgetCommessa",					"UltimoConsuntivo", null, ULTIMO_CONSUNTIVO, "single", false, false, null, null);			consuntivoButton.addAction(ultimoConsuntivoAction);			WebToolBarPullDownAction listaConsuntiviAction = new WebToolBarPullDownAction("ListaConsuntivi",					"action_submit", "new", "no", "it.thera.thip.produzione.commessa.resources.BudgetCommessa",					"ListaConsuntivi", null, LISTA_CONSUNTIVI, "single", false, false, null, null);			consuntivoButton.addAction(listaConsuntiviAction);			//36460 inizio			WebToolBarPullDownAction evoluzioneConsuntiviAction = new WebToolBarPullDownAction("EvoluzioneConsuntivi",					"action_submit", "new", "no", "it.thera.thip.produzione.commessa.resources.BudgetCommessa",					"EvoluzioneConsuntivi", null, EVOLUZIONE_CONSUNTIVI, "single", false, false, null, null);			consuntivoButton.addAction(evoluzioneConsuntiviAction);			//36460 fine		}				return consuntivoButton;	}	//35382 fine	//36460 inizio	protected void apriEvoluzioneBudget(ServletEnvironment se) throws ServletException, IOException{		ClassADCollection cadc = getClassADCollection("Commessa");		String key = getStringParameter(se.getRequest(), "thKey");		String idAzienda = KeyHelper.getTokenObjectKey(key,1);		String idCommessa = KeyHelper.getTokenObjectKey(key,2);		String commessaKey = KeyHelper.buildObjectKey(new Object[] {idAzienda,idCommessa});		String parameters = "?thAction=NEW&thClassName=EvoluzioneBudgetCommessa&ObjectKey=" + commessaKey ;		parameters += "&Opener=COMMESSA";		String url = "/" +com.thera.thermfw.base.IniFile.getValue("Web", "WebApplicationPath") +					 "/" + com.thera.thermfw.base.IniFile.getValue("thermfw.ini","Web", "ServletPath") +					 "/" + cadc.getActionAdapterNameWeb() + parameters;		se.getResponse().getOutputStream().print("<script>");		se.getResponse().getOutputStream().print("window.location = '" + url + "'; ");		se.getResponse().getOutputStream().print("</script>");	}		protected void apriEvoluzioneConsuntivo(ServletEnvironment se) throws ServletException, IOException{		ClassADCollection cadc = getClassADCollection("Commessa");		String key = getStringParameter(se.getRequest(), "thKey");		String idAzienda = KeyHelper.getTokenObjectKey(key,1);		String idCommessa = KeyHelper.getTokenObjectKey(key,2);		String commessaKey = KeyHelper.buildObjectKey(new Object[] {idAzienda,idCommessa});		String parameters = "?thAction=NEW&thClassName=EvoluzioneConsunCommessa&ObjectKey=" + commessaKey ;		parameters += "&Opener=COMMESSA";		String url = "/" +com.thera.thermfw.base.IniFile.getValue("Web", "WebApplicationPath") +					 "/" + com.thera.thermfw.base.IniFile.getValue("thermfw.ini","Web", "ServletPath") +					 "/" + cadc.getActionAdapterNameWeb() + parameters;		se.getResponse().getOutputStream().print("<script>");		se.getResponse().getOutputStream().print("window.location = '" + url + "'; ");		se.getResponse().getOutputStream().print("</script>");	}	//36460 fine}